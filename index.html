<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>í•˜ë£¨ 1íŒ í…ŒíŠ¸ë¦¬ìŠ¤</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta
      name="description"
      content="ì‹±ê¸€ / 2ì¸ / AI ëŒ€ì „ ê°€ëŠ¥í•œ í•˜ë£¨ 1íŒ í…ŒíŠ¸ë¦¬ìŠ¤"
    />
    <meta name="keywords" content="í…ŒíŠ¸ë¦¬ìŠ¤, AIê²Œì„, 2ì¸ê²Œì„, ì›¹ê²Œì„" />

    <meta property="og:title" content="í•˜ë£¨ 1íŒ í…ŒíŠ¸ë¦¬ìŠ¤" />
    <meta
      property="og:image"
      content="https://dummyimage.com/1200x630/000/fff&text=DAILY+TETRIS"
    />

    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body
    class="bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900 text-white min-h-screen flex flex-col items-center py-8"
  >
    <h1
      class="mt-4 text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent drop-shadow-lg"
    >
      ğŸ§± í•˜ë£¨ 1íŒ í…ŒíŠ¸ë¦¬ìŠ¤
    </h1>

    <!-- ëª¨ë“œ ì„ íƒ -->
    <div id="menu" class="mt-8 flex flex-col gap-4 items-center">
      <div class="flex gap-4">
        <button
          onclick="start('solo')"
          class="px-8 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 rounded-lg text-white font-bold text-lg shadow-lg transform transition-all hover:scale-105"
        >
          ğŸ¤– ì‹±ê¸€ (AI)
        </button>
        <button
          onclick="start('duo')"
          class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-lg text-white font-bold text-lg shadow-lg transform transition-all hover:scale-105"
        >
          ğŸ‘¥ 2ì¸ í”Œë ˆì´
        </button>
      </div>

      <select
        id="theme"
        class="text-black mt-4 p-3 rounded-lg text-lg font-semibold shadow-lg bg-white"
      >
        <option value="classic">ğŸ¨ Classic</option>
        <option value="neon">ğŸ’¡ Neon</option>
        <option value="pastel">ğŸŒ¸ Pastel</option>
        <option value="mono">âš« Mono</option>
      </select>
    </div>

    <!-- í†µê³„ -->
    <div id="stats" class="mt-6 text-lg text-zinc-300 font-semibold"></div>

    <!-- ê²Œì„ -->
    <div
      id="game"
      class="hidden mt-8 flex flex-col md:flex-row gap-8 items-start"
    >
      <!-- P1 íŒ¨ë„ -->
      <div class="flex flex-col items-center">
        <div
          class="bg-gradient-to-br from-zinc-800 to-zinc-900 rounded-xl p-6 shadow-2xl border-2 border-zinc-700"
        >
          <div class="text-center mb-4">
            <h2 class="text-2xl font-bold text-blue-400 mb-2">í”Œë ˆì´ì–´ 1</h2>
            <div id="p1-score" class="text-xl font-semibold text-yellow-400">
              ì ìˆ˜: 0
            </div>
            <button
              id="p1-resume-btn"
              onclick="resumePlayer(1)"
              class="hidden mt-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-lg text-white font-bold text-sm shadow-lg transform transition-all hover:scale-105"
            >
              â–¶ï¸ ë‹¤ì‹œ ì‹œì‘
            </button>
          </div>
          <canvas
            id="p1"
            width="400"
            height="720"
            class="bg-black rounded-lg border-4 border-zinc-600 shadow-inner w-full max-w-[400px] h-auto"
            style="image-rendering: pixelated"
          ></canvas>
        </div>
        <div id="p1-controls" class="mt-4 text-sm text-zinc-400 text-center">
          <div>â† â†’ ì´ë™ | â†‘ íšŒì „ | â†“ ë¹ ë¥¸ ë‚™í•˜</div>
          <div>ìŠ¤í˜ì´ìŠ¤ë°”: í•œ ë²ˆì— ë–¨ì–´ëœ¨ë¦¬ê¸°</div>
        </div>
      </div>

      <!-- P2 íŒ¨ë„ -->
      <div id="p2-panel" class="flex flex-col items-center hidden">
        <div
          class="bg-gradient-to-br from-zinc-800 to-zinc-900 rounded-xl p-6 shadow-2xl border-2 border-zinc-700"
        >
          <div class="text-center mb-4">
            <h2 class="text-2xl font-bold text-green-400 mb-2">í”Œë ˆì´ì–´ 2</h2>
            <div id="p2-score" class="text-xl font-semibold text-yellow-400">
              ì ìˆ˜: 0
            </div>
            <button
              id="p2-resume-btn"
              onclick="resumePlayer(2)"
              class="hidden mt-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 rounded-lg text-white font-bold text-sm shadow-lg transform transition-all hover:scale-105"
            >
              â–¶ï¸ ë‹¤ì‹œ ì‹œì‘
            </button>
          </div>
          <canvas
            id="p2"
            width="400"
            height="720"
            class="bg-black rounded-lg border-4 border-zinc-600 shadow-inner w-full max-w-[400px] h-auto"
            style="image-rendering: pixelated"
          ></canvas>
        </div>
        <div id="p2-controls" class="mt-4 text-sm text-zinc-400 text-center">
          <div>WASD ì´ë™ | W íšŒì „ | Enter ë¹ ë¥¸ ë‚™í•˜</div>
        </div>
      </div>
    </div>

    <div
      id="result"
      class="mt-6 text-3xl font-bold text-center min-h-[50px]"
    ></div>

    <!-- ê²Œì„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
    <div id="game-controls" class="hidden mt-4 flex gap-4 justify-center">
      <button
        onclick="pauseGame()"
        class="px-6 py-3 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700 rounded-lg text-white font-bold shadow-lg transform transition-all hover:scale-105"
      >
        â¸ï¸ ì¼ì‹œì •ì§€
      </button>
      <button
        onclick="saveGame()"
        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 rounded-lg text-white font-bold shadow-lg transform transition-all hover:scale-105"
      >
        ğŸ’¾ ì €ì¥í•˜ê¸°
      </button>
    </div>

    <!-- ê³µìœ í•˜ê¸° ë²„íŠ¼ -->
    <div
      id="share-buttons"
      class="hidden mt-6 flex gap-4 flex-wrap justify-center"
    ></div>

    <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
    <div id="mobile-controls" class="hidden mt-6 w-full max-w-md px-4 mx-auto">
      <div class="grid grid-cols-3 gap-4 mb-4">
        <button
          id="btn-left"
          class="p-4 bg-zinc-700 rounded-lg text-2xl font-bold active:bg-zinc-600 touch-manipulation"
        >
          â†
        </button>
        <button
          id="btn-rotate"
          class="p-4 bg-zinc-700 rounded-lg text-2xl font-bold active:bg-zinc-600 touch-manipulation"
        >
          â†»
        </button>
        <button
          id="btn-right"
          class="p-4 bg-zinc-700 rounded-lg text-2xl font-bold active:bg-zinc-600 touch-manipulation"
        >
          â†’
        </button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <button
          id="btn-down"
          class="p-4 bg-zinc-700 rounded-lg text-xl font-bold active:bg-zinc-600 touch-manipulation"
        >
          â†“ ë¹ ë¥¸ ë‚™í•˜
        </button>
        <button
          id="btn-hard-drop"
          class="p-4 bg-zinc-700 rounded-lg text-xl font-bold active:bg-zinc-600 touch-manipulation"
        >
          â¬‡ í•œ ë²ˆì—
        </button>
      </div>
    </div>

    <!-- ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸° -->
    <div class="mt-8 mb-4">
      <a
        href="https://funnyfunny.cloud/"
        target="_blank"
        class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-semibold transition-colors"
      >
        ğŸ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ë³´ê¸°
      </a>
    </div>

    <script>
      /* ===================== ì„¤ì • ===================== */
      const COLS = 10,
        ROWS = 18;
      const PIECES = "TJLOSZI";
      const THEMES = {
        classic: [
          "#facc15",
          "#22d3ee",
          "#fb923c",
          "#60a5fa",
          "#4ade80",
          "#f87171",
          "#c084fc",
        ],
        neon: ["#0ff", "#f0f", "#ff0", "#0f0", "#f00", "#00f", "#fff"],
        pastel: [
          "#fde68a",
          "#bae6fd",
          "#fecaca",
          "#bbf7d0",
          "#e9d5ff",
          "#ddd6fe",
          "#fed7aa",
        ],
        mono: ["#999", "#aaa", "#bbb", "#ccc", "#ddd", "#eee", "#fff"],
      };
      let COLORS = THEMES.classic;

      /* ===================== í†µê³„ ===================== */
      let stats = JSON.parse(
        localStorage.stats || '{"play":0,"win":0,"lose":0}'
      );
      function saveStats() {
        localStorage.stats = JSON.stringify(stats);
      }
      function showStats() {
        stats.play++;
        saveStats();
        document.getElementById(
          "stats"
        ).textContent = `í”Œë ˆì´ ${stats.play} | ìŠ¹ ${stats.win} | íŒ¨ ${stats.lose}`;
      }

      /* ===================== ì‚¬ìš´ë“œ ===================== */
      let ctx = null;
      let bgmSource = null;
      let bgmGain = null;

      function initAudio() {
        if (!ctx) {
          ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (ctx.state === "suspended") {
          ctx.resume();
        }
      }

      function beep(freq = 400, dur = 0.1) {
        try {
          initAudio();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.frequency.value = freq;
          o.connect(g);
          g.connect(ctx.destination);
          o.start();
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
          o.stop(ctx.currentTime + dur);
        } catch (e) {
          // ì‚¬ìš´ë“œ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
        }
      }

      function startBGM() {
        try {
          initAudio();
          if (bgmSource) {
            stopBGM();
          }

          // í…ŒíŠ¸ë¦¬ìŠ¤ BGM (Korobeiniki) - ì •í™•í•œ ë©œë¡œë””
          const melody = [
            // ì²« ë²ˆì§¸ êµ¬ì ˆ
            { freq: 523.25, dur: 0.12 }, // E5
            { freq: 493.88, dur: 0.12 }, // B4
            { freq: 440, dur: 0.12 }, // A4
            { freq: 392, dur: 0.12 }, // G4
            { freq: 349.23, dur: 0.24 }, // F4
            { freq: 392, dur: 0.12 }, // G4
            { freq: 440, dur: 0.24 }, // A4
            { freq: 392, dur: 0.12 }, // G4
            { freq: 349.23, dur: 0.12 }, // F4
            { freq: 329.63, dur: 0.12 }, // E4
            { freq: 293.66, dur: 0.24 }, // D4
            // ë‘ ë²ˆì§¸ êµ¬ì ˆ
            { freq: 293.66, dur: 0.12 }, // D4
            { freq: 349.23, dur: 0.12 }, // F4
            { freq: 392, dur: 0.24 }, // G4
            { freq: 349.23, dur: 0.12 }, // F4
            { freq: 329.63, dur: 0.12 }, // E4
            { freq: 293.66, dur: 0.24 }, // D4
            // ì„¸ ë²ˆì§¸ êµ¬ì ˆ
            { freq: 440, dur: 0.12 }, // A4
            { freq: 493.88, dur: 0.12 }, // B4
            { freq: 523.25, dur: 0.12 }, // E5
            { freq: 493.88, dur: 0.12 }, // B4
            { freq: 440, dur: 0.12 }, // A4
            { freq: 392, dur: 0.12 }, // G4
            { freq: 349.23, dur: 0.24 }, // F4
            { freq: 392, dur: 0.12 }, // G4
            { freq: 440, dur: 0.24 }, // A4
            // ë„¤ ë²ˆì§¸ êµ¬ì ˆ
            { freq: 392, dur: 0.12 }, // G4
            { freq: 349.23, dur: 0.12 }, // F4
            { freq: 329.63, dur: 0.12 }, // E4
            { freq: 293.66, dur: 0.24 }, // D4
            { freq: 293.66, dur: 0.12 }, // D4
            { freq: 349.23, dur: 0.12 }, // F4
            { freq: 392, dur: 0.24 }, // G4
            { freq: 349.23, dur: 0.12 }, // F4
            { freq: 329.63, dur: 0.12 }, // E4
            { freq: 293.66, dur: 0.36 }, // D4
          ];

          bgmGain = ctx.createGain();
          bgmGain.gain.value = 0.2;
          bgmGain.connect(ctx.destination);

          let loopTimeout = null;
          let isPlaying = true;

          function playNote(note, time) {
            try {
              const o = ctx.createOscillator();
              const g = ctx.createGain();
              o.type = "square";
              o.frequency.value = note.freq;
              o.connect(g);
              g.connect(bgmGain);
              g.gain.setValueAtTime(0.15, time);
              g.gain.exponentialRampToValueAtTime(0.01, time + note.dur);
              o.start(time);
              o.stop(time + note.dur);
            } catch (e) {
              // ë…¸íŠ¸ ì¬ìƒ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
            }
          }

          function playLoop() {
            if (!gameRunning || !isPlaying) {
              bgmSource = null;
              if (loopTimeout) clearTimeout(loopTimeout);
              return;
            }

            const startTime = ctx.currentTime;
            let noteTime = startTime;

            melody.forEach((note) => {
              playNote(note, noteTime);
              noteTime += note.dur;
            });

            const totalDur = noteTime - startTime;
            loopTimeout = setTimeout(() => {
              if (gameRunning && isPlaying) {
                playLoop();
              }
            }, totalDur * 1000);
          }

          bgmSource = {
            stop: () => {
              isPlaying = false;
              if (loopTimeout) {
                clearTimeout(loopTimeout);
                loopTimeout = null;
              }
            },
          };

          // ì•½ê°„ì˜ ì§€ì—° í›„ ì‹œì‘ (AudioContextê°€ ì¤€ë¹„ë  ì‹œê°„)
          setTimeout(() => {
            if (gameRunning) {
              playLoop();
            }
          }, 100);
        } catch (e) {
          console.error("BGM ì˜¤ë¥˜:", e);
        }
      }

      function stopBGM() {
        if (bgmSource) {
          bgmSource.stop();
          bgmSource = null;
        }
        if (bgmGain) {
          bgmGain.gain.cancelScheduledValues(ctx.currentTime);
          bgmGain.gain.setValueAtTime(0, ctx.currentTime);
          bgmGain = null;
        }
      }

      /* ===================== ì—”ì§„ ===================== */
      function arena() {
        return Array.from({ length: ROWS }, () => Array(COLS).fill(0));
      }
      function piece(t) {
        return {
          T: [
            [0, 1, 0],
            [1, 1, 1],
          ],
          O: [
            [2, 2],
            [2, 2],
          ],
          L: [
            [0, 0, 3],
            [3, 3, 3],
          ],
          J: [
            [4, 0, 0],
            [4, 4, 4],
          ],
          I: [[5, 5, 5, 5]],
          S: [
            [0, 6, 6],
            [6, 6, 0],
          ],
          Z: [
            [7, 7, 0],
            [0, 7, 7],
          ],
        }[t];
      }
      function rand() {
        return PIECES[(Math.random() * 7) | 0];
      }

      function Player(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext("2d");
        this.ctx.scale(40, 40); // ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ê²Œ ìŠ¤ì¼€ì¼ ì¡°ì • (400/10 = 40)
        this.field = arena();
        this.matrix = piece(rand());
        this.pos = { x: 3, y: 0 };
        this.score = 0;
        this.lines = 0;
        this.gameOver = false;
      }

      function collide(p, offset = { x: 0, y: 0 }) {
        const pos = { x: p.pos.x + offset.x, y: p.pos.y + offset.y };
        return p.matrix.some((r, y) =>
          r.some((v, x) => {
            if (!v) return false;
            const nx = x + pos.x;
            const ny = y + pos.y;
            return (
              nx < 0 ||
              nx >= COLS ||
              ny >= ROWS ||
              (ny >= 0 && p.field[ny]?.[nx] !== 0)
            );
          })
        );
      }

      function rotate(m) {
        const rows = m.length;
        const cols = m[0].length;
        const rotated = Array.from({ length: cols }, () => Array(rows).fill(0));
        for (let y = 0; y < rows; y++) {
          for (let x = 0; x < cols; x++) {
            rotated[x][rows - 1 - y] = m[y][x];
          }
        }
        return rotated;
      }

      function tryRotate(p) {
        const rotated = rotate(p.matrix);
        const oldMatrix = p.matrix;
        const oldPos = { ...p.pos };

        // íšŒì „ ì‹œë„
        p.matrix = rotated;

        // ì¶©ëŒ ì²´í¬
        if (!collide(p)) {
          return true;
        }

        // Wall kick ì‹œë„: ì™¼ìª½ìœ¼ë¡œ 1ì¹¸
        p.pos.x--;
        if (!collide(p)) {
          return true;
        }

        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ 1ì¹¸
        p.pos.x += 2;
        if (!collide(p)) {
          return true;
        }

        // ì™¼ìª½ìœ¼ë¡œ 2ì¹¸
        p.pos.x -= 3;
        if (!collide(p)) {
          return true;
        }

        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ 2ì¹¸
        p.pos.x += 4;
        if (!collide(p)) {
          return true;
        }

        // ì‹¤íŒ¨ ì‹œ ì›ë˜ëŒ€ë¡œ
        p.matrix = oldMatrix;
        p.pos = oldPos;
        return false;
      }

      function merge(p) {
        p.matrix.forEach((r, y) =>
          r.forEach((v, x) => {
            if (v && y + p.pos.y >= 0) {
              p.field[y + p.pos.y][x + p.pos.x] = v;
            }
          })
        );
      }

      function sweep(p) {
        let c = 0;
        for (let y = ROWS - 1; y >= 0; y--) {
          if (p.field[y].every((v) => v)) {
            p.field.splice(y, 1);
            p.field.unshift(Array(COLS).fill(0));
            c++;
            y++;
          }
        }
        if (c) {
          p.lines += c;
          // ë¼ì¸ ìˆ˜ì— ë”°ë¥¸ ì ìˆ˜ ê³„ì‚°
          const points = [0, 100, 300, 500, 800];
          p.score += points[c] || c * 100;
          beep(600);
          navigator.vibrate?.(50);
        }
      }

      function draw(p) {
        const ctx = p.ctx;
        ctx.clearRect(0, 0, COLS, ROWS);

        // ë°°ê²½
        ctx.fillStyle = "#0a0a0a";
        ctx.fillRect(0, 0, COLS, ROWS);

        // ê·¸ë¦¬ë“œ ë¼ì¸
        ctx.strokeStyle = "#1a1a1a";
        ctx.lineWidth = 0.02;
        for (let x = 0; x <= COLS; x++) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, ROWS);
          ctx.stroke();
        }
        for (let y = 0; y <= ROWS; y++) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(COLS, y);
          ctx.stroke();
        }

        // ê³ ì •ëœ ë¸”ë¡
        p.field.forEach((r, y) =>
          r.forEach((v, x) => {
            if (v) {
              ctx.fillStyle = COLORS[v - 1];
              ctx.fillRect(x + 0.05, y + 0.05, 0.9, 0.9);
              // í•˜ì´ë¼ì´íŠ¸
              ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
              ctx.fillRect(x + 0.05, y + 0.05, 0.9, 0.2);
            }
          })
        );

        // í˜„ì¬ ë¸”ë¡
        p.matrix.forEach((r, y) =>
          r.forEach((v, x) => {
            if (v) {
              const drawY = y + p.pos.y;
              if (drawY >= 0) {
                ctx.fillStyle = COLORS[v - 1];
                ctx.fillRect(x + p.pos.x + 0.05, drawY + 0.05, 0.9, 0.9);
                // í•˜ì´ë¼ì´íŠ¸
                ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
                ctx.fillRect(x + p.pos.x + 0.05, drawY + 0.05, 0.9, 0.2);
              }
            }
          })
        );

        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        const scoreEl =
          p === p1
            ? document.getElementById("p1-score")
            : document.getElementById("p2-score");
        if (scoreEl) {
          scoreEl.textContent = `ì ìˆ˜: ${p.score} | ë¼ì¸: ${p.lines}`;
        }
      }

      /* ===================== AI ===================== */
      function aiMove(ai) {
        if (!ai) return;
        const dir = Math.random() < 0.5 ? -1 : 1;
        ai.pos.x += dir;
        if (collide(ai)) {
          ai.pos.x -= dir;
        }
        if (Math.random() < 0.1) {
          tryRotate(ai);
        }
      }

      /* ===================== ì‹œì‘ ===================== */
      let p1,
        p2,
        mode,
        gameRunning = false;
      const keys = {};
      const keyTimers = {};

      function handleKey(player, actions) {
        if (!player) return;

        if (actions.left) {
          player.pos.x--;
          if (collide(player)) player.pos.x++;
          else beep(200, 0.05);
        }
        if (actions.right) {
          player.pos.x++;
          if (collide(player)) player.pos.x--;
          else beep(200, 0.05);
        }
        if (actions.down) {
          drop(player);
        }
        if (actions.rotate) {
          if (tryRotate(player)) {
            beep(300, 0.05);
          }
        }
        if (actions.hardDrop) {
          while (!collide(player, { x: 0, y: 1 })) {
            player.pos.y++;
          }
          drop(player);
        }
      }

      function startKeyRepeat(keyCode, player, actions) {
        if (keyTimers[keyCode]) return;

        // ì¦‰ì‹œ ì‹¤í–‰
        handleKey(player, actions);

        // ì²« ë°˜ë³µì€ ì•½ê°„ ëŠ¦ê²Œ
        keyTimers[keyCode] = setTimeout(() => {
          const interval = setInterval(() => {
            if (!keys[keyCode] || !gameRunning) {
              clearInterval(interval);
              keyTimers[keyCode] = null;
              return;
            }
            handleKey(player, actions);
          }, 50); // ë¹ ë¥¸ ë°˜ë³µ (50ms)

          keyTimers[keyCode] = interval;
        }, 200); // ì²« ë°˜ë³µê¹Œì§€ 200ms ëŒ€ê¸°
      }

      function stopKeyRepeat(keyCode) {
        if (keyTimers[keyCode]) {
          if (typeof keyTimers[keyCode] === "number") {
            clearTimeout(keyTimers[keyCode]);
          } else {
            clearInterval(keyTimers[keyCode]);
          }
          keyTimers[keyCode] = null;
        }
      }

      // ìŠ¤í¬ë¡¤ ë°©ì§€ë¥¼ ìœ„í•œ ì „ì—­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
      document.addEventListener(
        "keydown",
        (e) => {
          // ê²Œì„ ì¤‘ì¼ ë•Œë§Œ ë°©í–¥í‚¤ì™€ ìŠ¤í˜ì´ìŠ¤ë°” ìŠ¤í¬ë¡¤ ë°©ì§€
          if (gameRunning) {
            if (
              ["ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", " "].includes(
                e.key
              )
            ) {
              e.preventDefault();
            }
          }
        },
        { passive: false }
      );

      document.addEventListener("keydown", (e) => {
        if (!gameRunning) return;
        const key = e.key.toLowerCase();
        const keyCode = e.key;

        // ì´ë¯¸ ëˆŒë¦° í‚¤ëŠ” ë¬´ì‹œ (í‚¤ ë°˜ë³µ ë°©ì§€)
        if (keys[keyCode] || (key !== keyCode && keys[key])) return;

        const code = e.code;

        if (mode === "duo") {
          // 2P ëª¨ë“œ: 1PëŠ” WASD + ìŠ¤í˜ì´ìŠ¤, 2PëŠ” ë°©í–¥í‚¤ + ì—”í„°

          // P1 ì»¨íŠ¸ë¡¤ (WASD + ìŠ¤í˜ì´ìŠ¤)
          if (p1) {
            if (code === "KeyA" || key === "a") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p1-a";
              if (!keys[keyId]) {
                keys[keyId] = true;
                startKeyRepeat(keyId, p1, { left: true });
              }
            } else if (code === "KeyD" || key === "d") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p1-d";
              if (!keys[keyId]) {
                keys[keyId] = true;
                startKeyRepeat(keyId, p1, { right: true });
              }
            } else if (code === "KeyS" || key === "s") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p1-s";
              if (!keys[keyId]) {
                keys[keyId] = true;
                startKeyRepeat(keyId, p1, { down: true });
              }
            } else if (code === "KeyW" || key === "w") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p1-w";
              if (!keys[keyId]) {
                keys[keyId] = true;
                handleKey(p1, { rotate: true });
              }
            } else if (keyCode === " " && p1) {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p1-space";
              if (!keys[keyId]) {
                keys[keyId] = true;
                handleKey(p1, { hardDrop: true });
              }
            }
          }

          // P2 ì»¨íŠ¸ë¡¤ (ë°©í–¥í‚¤ + ì—”í„°)
          if (p2) {
            if (keyCode === "ArrowLeft") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p2-ArrowLeft";
              if (!keys[keyId]) {
                keys[keyId] = true;
                startKeyRepeat(keyId, p2, { left: true });
              }
            } else if (keyCode === "ArrowRight") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p2-ArrowRight";
              if (!keys[keyId]) {
                keys[keyId] = true;
                startKeyRepeat(keyId, p2, { right: true });
              }
            } else if (keyCode === "ArrowDown") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p2-ArrowDown";
              if (!keys[keyId]) {
                keys[keyId] = true;
                startKeyRepeat(keyId, p2, { down: true });
              }
            } else if (keyCode === "ArrowUp") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p2-ArrowUp";
              if (!keys[keyId]) {
                keys[keyId] = true;
                handleKey(p2, { rotate: true });
              }
            } else if (code === "Enter" || keyCode === "Enter") {
              e.preventDefault();
              e.stopPropagation();
              const keyId = "p2-enter";
              if (!keys[keyId]) {
                keys[keyId] = true;
                handleKey(p2, { hardDrop: true });
              }
            }
          }
        } else {
          // 1P í˜¼ì: ë°©í–¥í‚¤ + ìŠ¤í˜ì´ìŠ¤
          if (keyCode === "ArrowLeft" && p1) {
            e.preventDefault();
            e.stopPropagation();
            keys["ArrowLeft"] = true;
            startKeyRepeat("ArrowLeft", p1, { left: true });
          }
          if (keyCode === "ArrowRight" && p1) {
            e.preventDefault();
            e.stopPropagation();
            keys["ArrowRight"] = true;
            startKeyRepeat("ArrowRight", p1, { right: true });
          }
          if (keyCode === "ArrowDown" && p1) {
            e.preventDefault();
            e.stopPropagation();
            keys["ArrowDown"] = true;
            startKeyRepeat("ArrowDown", p1, { down: true });
          }
          if (keyCode === "ArrowUp" && p1) {
            e.preventDefault();
            e.stopPropagation();
            keys["ArrowUp"] = true;
            handleKey(p1, { rotate: true });
          }
          if (keyCode === " " && p1) {
            e.preventDefault();
            e.stopPropagation();
            keys[" "] = true;
            handleKey(p1, { hardDrop: true });
          }
        }
      });

      // ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤
      function initMobileControls() {
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );
        const mobileControls = document.getElementById("mobile-controls");

        if (!mobileControls) return;

        // ê²Œì„ ì¤‘ì¼ ë•Œë§Œ í‘œì‹œ
        if (isMobile && gameRunning) {
          mobileControls.classList.remove("hidden");
        } else {
          mobileControls.classList.add("hidden");
        }

        // í„°ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById("btn-left")?.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            if (p1 && gameRunning) {
              handleKey(p1, { left: true });
            }
          },
          { passive: false }
        );

        document.getElementById("btn-right")?.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            if (p1 && gameRunning) {
              handleKey(p1, { right: true });
            }
          },
          { passive: false }
        );

        document.getElementById("btn-rotate")?.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            if (p1 && gameRunning) {
              handleKey(p1, { rotate: true });
            }
          },
          { passive: false }
        );

        document.getElementById("btn-down")?.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            if (p1 && gameRunning) {
              handleKey(p1, { down: true });
            }
          },
          { passive: false }
        );

        document.getElementById("btn-hard-drop")?.addEventListener(
          "touchstart",
          (e) => {
            e.preventDefault();
            if (p1 && gameRunning) {
              handleKey(p1, { hardDrop: true });
            }
          },
          { passive: false }
        );

        // ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener(
          "touchstart",
          (e) => {
            if (!gameRunning || !p1) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
          },
          { passive: true }
        );

        document.addEventListener(
          "touchend",
          (e) => {
            if (!gameRunning || !p1) return;
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            const threshold = 30;

            if (Math.abs(diffX) > Math.abs(diffY)) {
              // ì¢Œìš° ìŠ¤ì™€ì´í”„
              if (Math.abs(diffX) > threshold) {
                if (diffX > 0) {
                  handleKey(p1, { right: true });
                } else {
                  handleKey(p1, { left: true });
                }
              }
            } else {
              // ìƒí•˜ ìŠ¤ì™€ì´í”„
              if (Math.abs(diffY) > threshold) {
                if (diffY > 0) {
                  handleKey(p1, { down: true });
                } else {
                  handleKey(p1, { rotate: true });
                }
              }
            }
          },
          { passive: true }
        );
      }

      document.addEventListener("keyup", (e) => {
        const key = e.key.toLowerCase();
        const keyCode = e.key;
        const code = e.code;

        if (mode === "duo") {
          // 2P ëª¨ë“œ: 1PëŠ” WASD + ìŠ¤í˜ì´ìŠ¤, 2PëŠ” ë°©í–¥í‚¤ + ì—”í„°

          // P1 í‚¤ í•´ì œ (WASD + ìŠ¤í˜ì´ìŠ¤)
          if (code === "KeyA" || key === "a") {
            keys["p1-a"] = false;
            stopKeyRepeat("p1-a");
          }
          if (code === "KeyD" || key === "d") {
            keys["p1-d"] = false;
            stopKeyRepeat("p1-d");
          }
          if (code === "KeyS" || key === "s") {
            keys["p1-s"] = false;
            stopKeyRepeat("p1-s");
          }
          if (code === "KeyW" || key === "w") {
            keys["p1-w"] = false;
          }
          if (keyCode === " ") {
            keys["p1-space"] = false;
          }

          // P2 í‚¤ í•´ì œ (ë°©í–¥í‚¤ + ì—”í„°)
          if (keyCode === "ArrowLeft") {
            keys["p2-ArrowLeft"] = false;
            stopKeyRepeat("p2-ArrowLeft");
          }
          if (keyCode === "ArrowRight") {
            keys["p2-ArrowRight"] = false;
            stopKeyRepeat("p2-ArrowRight");
          }
          if (keyCode === "ArrowDown") {
            keys["p2-ArrowDown"] = false;
            stopKeyRepeat("p2-ArrowDown");
          }
          if (keyCode === "ArrowUp") {
            keys["p2-ArrowUp"] = false;
          }
          if (code === "Enter" || keyCode === "Enter") {
            keys["p2-enter"] = false;
          }
        } else {
          // 1P í˜¼ì: ë°©í–¥í‚¤ + ìŠ¤í˜ì´ìŠ¤
          if (keyCode === "ArrowLeft") {
            keys["ArrowLeft"] = false;
            stopKeyRepeat("ArrowLeft");
          }
          if (keyCode === "ArrowRight") {
            keys["ArrowRight"] = false;
            stopKeyRepeat("ArrowRight");
          }
          if (keyCode === "ArrowDown") {
            keys["ArrowDown"] = false;
            stopKeyRepeat("ArrowDown");
          }
          if (keyCode === "ArrowUp") {
            keys["ArrowUp"] = false;
          }
          if (keyCode === " ") {
            keys[" "] = false;
          }
        }
      });

      function start(m) {
        mode = m;
        gameRunning = true;
        gamePaused = false;
        p1GameOver = false;
        p2GameOver = false;
        COLORS = THEMES[document.getElementById("theme").value];
        document.getElementById("menu").classList.add("hidden");
        document.getElementById("game").classList.remove("hidden");
        document.getElementById("game-controls").classList.remove("hidden");
        document.getElementById("result").textContent = "";

        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        const p1Canvas = document.getElementById("p1");
        const p2Canvas = document.getElementById("p2");
        p1Canvas.width = 400;
        p1Canvas.height = 720;
        p2Canvas.width = 400;
        p2Canvas.height = 720;

        if (mode === "duo" || mode === "solo") {
          document.getElementById("p2-panel").classList.remove("hidden");
        } else {
          document.getElementById("p2-panel").classList.add("hidden");
        }
        p1 = new Player(p1Canvas);
        if (mode === "duo" || mode === "solo") p2 = new Player(p2Canvas);
        else p2 = null;
        showStats();
        last = 0;

        // AudioContext ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ BGM ì‹œì‘
        initAudio();
        setTimeout(() => {
          startBGM();
        }, 100);

        // ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
        initMobileControls();

        // ë‹¤ì‹œ ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        document.getElementById("p1-resume-btn").classList.add("hidden");
        document.getElementById("p2-resume-btn").classList.add("hidden");

        // ì¡°ì‘ë²• ì•ˆë‚´ ì—…ë°ì´íŠ¸
        if (mode === "duo") {
          document.getElementById("p1-controls").innerHTML = `
            <div>WASD ì´ë™ | W íšŒì „ | S ë¹ ë¥¸ ë‚™í•˜</div>
            <div>ìŠ¤í˜ì´ìŠ¤ë°”: í•œ ë²ˆì— ë–¨ì–´ëœ¨ë¦¬ê¸°</div>
          `;
          document.getElementById("p2-controls").innerHTML = `
            <div>â† â†’ ì´ë™ | â†‘ íšŒì „ | â†“ ë¹ ë¥¸ ë‚™í•˜</div>
            <div>Enter: í•œ ë²ˆì— ë–¨ì–´ëœ¨ë¦¬ê¸°</div>
          `;
        } else {
          document.getElementById("p1-controls").innerHTML = `
            <div>â† â†’ ì´ë™ | â†‘ íšŒì „ | â†“ ë¹ ë¥¸ ë‚™í•˜</div>
            <div>ìŠ¤í˜ì´ìŠ¤ë°”: í•œ ë²ˆì— ë–¨ì–´ëœ¨ë¦¬ê¸°</div>
          `;
        }

        loop();
      }

      function pauseGame() {
        if (!gameRunning) return;
        gamePaused = !gamePaused;
        if (gamePaused) {
          document.getElementById("result").textContent = "â¸ï¸ ì¼ì‹œì •ì§€";
        } else {
          document.getElementById("result").textContent = "";
        }
      }

      /* ===================== ë£¨í”„ ===================== */
      function drop(p) {
        if (!p) return;
        p.pos.y++;
        if (collide(p)) {
          p.pos.y--;
          merge(p);
          sweep(p);
          p.matrix = piece(rand());
          p.pos = { x: 3, y: 0 };
          if (collide(p)) {
            // ê²Œì„ ì˜¤ë²„ ì²˜ë¦¬ (ê²Œì„ì€ ê³„ì† ì§„í–‰)
            if (p === p1) {
              p1GameOver = true;
              beep(200, 0.3);
              navigator.vibrate?.(100);
              document
                .getElementById("p1-resume-btn")
                .classList.remove("hidden");
              if (mode === "duo") {
                if (!p2GameOver) {
                  document.getElementById("result").textContent =
                    "ğŸ‰ 2P ìŠ¹ë¦¬! (1PëŠ” ë‹¤ì‹œ ì‹œì‘ ê°€ëŠ¥)";
                  stats.win++;
                }
              } else {
                document.getElementById(
                  "result"
                ).textContent = `ê²Œì„ ì˜¤ë²„! ì ìˆ˜: ${p1.score} | ë¼ì¸: ${p1.lines}`;
                stats.lose++;
              }
              saveStats();
            } else if (p === p2) {
              p2GameOver = true;
              beep(200, 0.3);
              navigator.vibrate?.(100);
              document
                .getElementById("p2-resume-btn")
                .classList.remove("hidden");
              if (mode === "duo") {
                if (!p1GameOver) {
                  document.getElementById("result").textContent =
                    "ğŸ‰ 1P ìŠ¹ë¦¬! (2PëŠ” ë‹¤ì‹œ ì‹œì‘ ê°€ëŠ¥)";
                  stats.win++;
                }
              }
              saveStats();
            }

            // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ê²Œì„ ì˜¤ë²„ë˜ë©´ ê²Œì„ ì¢…ë£Œ
            if (
              (p1GameOver && (mode === "solo" || !p2)) ||
              (mode === "duo" && p1GameOver && p2GameOver)
            ) {
              setTimeout(() => {
                stopBGM();
                Object.keys(keyTimers).forEach((key) => {
                  stopKeyRepeat(key);
                });
                document.getElementById("menu").classList.remove("hidden");
                document.getElementById("game").classList.add("hidden");
                document
                  .getElementById("game-controls")
                  .classList.add("hidden");
                const shareButtonsEl = document.getElementById("share-buttons");
                if (shareButtonsEl) shareButtonsEl.classList.add("hidden");
                const mobileControls =
                  document.getElementById("mobile-controls");
                if (mobileControls) mobileControls.classList.add("hidden");
                gameRunning = false;
              }, 3000);
            }
            return;
          }
        }
      }

      let last = 0;
      function loop(t = 0) {
        if (!gameRunning || gamePaused) {
          if (gamePaused) {
            requestAnimationFrame(loop);
          }
          return;
        }

        if (t - last > 700) {
          if (!p1GameOver && p1) drop(p1);
          if (mode === "duo" && p2 && !p2GameOver) drop(p2);
          if (mode === "solo" && p2 && !p2GameOver) {
            drop(p2);
            aiMove(p2);
          }
          last = t;
        }

        if (p1 && !p1GameOver) draw(p1);
        else if (p1 && p1GameOver) {
          // ê²Œì„ ì˜¤ë²„ëœ í”Œë ˆì´ì–´ëŠ” íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ
          const ctx = p1.ctx;
          ctx.clearRect(0, 0, COLS, ROWS);
          ctx.fillStyle = "#000";
          ctx.fillRect(0, 0, COLS, ROWS);
          ctx.fillStyle = "rgba(100, 100, 100, 0.5)";
          ctx.fillRect(0, 0, COLS, ROWS);

          // ê²Œì„ ì˜¤ë²„ í…ìŠ¤íŠ¸
          ctx.fillStyle = "#fff";
          ctx.font = "bold 1.5px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          const centerX = COLS / 2;
          const centerY = ROWS / 2;

          // í…ìŠ¤íŠ¸ ë°°ê²½
          ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
          ctx.fillRect(centerX - 3, centerY - 1.5, 6, 3);

          // í…ìŠ¤íŠ¸
          ctx.fillStyle = "#ff0000";
          ctx.fillText("GAME", centerX, centerY - 0.5);
          ctx.fillText("OVER", centerX, centerY + 0.5);
        }

        if ((mode === "duo" || mode === "solo") && p2) {
          if (!p2GameOver) draw(p2);
          else {
            const ctx = p2.ctx;
            ctx.clearRect(0, 0, COLS, ROWS);
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, COLS, ROWS);
            ctx.fillStyle = "rgba(100, 100, 100, 0.5)";
            ctx.fillRect(0, 0, COLS, ROWS);

            // ê²Œì„ ì˜¤ë²„ í…ìŠ¤íŠ¸
            ctx.fillStyle = "#fff";
            ctx.font = "bold 1.5px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            const centerX = COLS / 2;
            const centerY = ROWS / 2;

            // í…ìŠ¤íŠ¸ ë°°ê²½
            ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
            ctx.fillRect(centerX - 3, centerY - 1.5, 6, 3);

            // í…ìŠ¤íŠ¸
            ctx.fillStyle = "#ff0000";
            ctx.fillText("GAME", centerX, centerY - 0.5);
            ctx.fillText("OVER", centerX, centerY + 0.5);
          }
        }
        requestAnimationFrame(loop);
      }

      let lastWinner = null;

      function shareResult() {
        const resultText = document.getElementById("result").textContent;
        const scoreText =
          mode === "duo"
            ? `${lastWinner}P ìŠ¹ë¦¬!`
            : `ì ìˆ˜: ${p1?.score || 0} | ë¼ì¸: ${p1?.lines || 0}`;
        const shareText = `ğŸ§± í•˜ë£¨ 1íŒ í…ŒíŠ¸ë¦¬ìŠ¤\n${resultText}\n${scoreText}\n\nhttps://funnyfunny.cloud/`;

        if (navigator.share) {
          navigator
            .share({
              title: "í•˜ë£¨ 1íŒ í…ŒíŠ¸ë¦¬ìŠ¤",
              text: shareText,
              url: window.location.href,
            })
            .catch(() => {
              // ê³µìœ  ì·¨ì†Œ ì‹œ ë¬´ì‹œ
            });
        } else {
          // í´ë¦½ë³´ë“œì— ë³µì‚¬
          navigator.clipboard
            .writeText(shareText)
            .then(() => {
              alert("ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            })
            .catch(() => {
              // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ í‘œì‹œ
              prompt("ê²°ê³¼ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:", shareText);
            });
        }
      }

      function copyLink() {
        const url = window.location.href;
        navigator.clipboard
          .writeText(url)
          .then(() => {
            alert("ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
          })
          .catch(() => {
            // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ í‘œì‹œ
            prompt("ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:", url);
          });
      }

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
      window.shareResult = shareResult;
      window.copyLink = copyLink;
      window.pauseGame = pauseGame;
      window.resumePlayer = resumePlayer;
      window.pauseGame = pauseGame;
      window.saveGame = saveGame;
      window.resumeGame = resumeGame;
    </script>
  </body>
</html>
